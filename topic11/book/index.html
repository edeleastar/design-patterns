 <!DOCTYPE html>
 <html>
   <head>
     <meta charset="utf-8" />
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
   
     <title> Lab-11 </title>
   
     <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
     <link rel="stylesheet" href="./style/semantic/css/semantic.min.css" type="text/css">  
     <link rel="stylesheet" href="./style/custom/main.css" type="text/css"> 
   
     <script src="./style/custom/jquery-2.1.0.min.js"></script> 
     <script src="./style/custom/jquery.address-1.6.min.js"></script>
     <script src="./style/semantic/javascript/semantic.min.js"></script>
   
     <link rel="stylesheet" href="./style/highlight/school_book.css">
     <script src="./style/highlight/highlight.pack.js"></script> 
     <script>hljs.initHighlightingOnLoad();</script>
   
     <script src="./style/custom/common.js"> </script> 
     <script src="./style/custom/main.js"> </script> 
  </head>
  <body>
  <nav class="ui fixed top pointing borderless inverted menu">
    <header class="header item"> <a href="../index.html">Node, Ember & Docker</a></header>
    <div class="right tab-menu menu">
          <a class="item" data-tab="Lab-11"> Lab-11 </a>
          <a class="item" data-tab="01"> 01 </a>
          <a class="item" data-tab="02"> 02 </a>
          <a class="item" data-tab="03"> 03 </a>
          <a class="item" data-tab="04"> 04 </a>
          <a class="item" data-tab="05"> 05 </a>
          <a class="item" data-tab="06"> 06 </a>
          <a class="item" data-tab="07"> 07 </a>
          <a class="item" data-tab="Exercises"> Exercises </a>
    </div>
  </nav>

  <br>

	  <section data-tab="Lab-11" class="ui tab stacked moodle-book segment">
	     <h1>Objectives</h1>
<ul>
<li>Build a version of the pacemaker-service API in node.js</li>
<li>Extend this with a User Interface based on ember.js</li>
<li>Encapsulate this service in a Docker container.</li>
</ul>
	  </section>
	  <section data-tab="01" class="ui tab stacked moodle-book segment">
	     <h1>Setup</h1>
<p>Install the latest version of node.js:</p>
<ul>
<li><a href="http://nodejs.org/download">http://nodejs.org/download</a></li>
</ul>
<p>If install successful, node should be available on the command line:</p>
<pre><code>$ node --version
v0.10.26
$
</code></pre>

<p>Create a folder called <code>pacemaker-node</code> - this will contain the node.js application. In this folder, create the following </p>
<h2>package.json:</h2>
<pre><code class="java">{
  &quot;name&quot;: &quot;pacemaker-node&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;private&quot;: true,
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;node app&quot;
  },
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;~4.0.0&quot;,
    &quot;sequelize&quot;: &quot;^1.7.2&quot;,
    &quot;body-parser&quot;: &quot;^1.0.2&quot;
  }
}
</code></pre>
	  </section>
	  <section data-tab="02" class="ui tab stacked moodle-book segment">
	     <h1>Model Infrastructure</h1>
<p>Create a folder called <code>pacemaker-node</code> - this will contain the node.js application.</p>
<p>pacemaker-node will use this node.js compatible ORM library:</p>
<ul>
<li><a href="http://sequelizejs.com">http://sequelizejs.com</a></li>
</ul>
<p>This is installed using the following command:</p>
<pre><code>npm install sequelize
</code></pre>

<p>It should respond with something like this:</p>
<pre><code>npm http GET https://registry.npmjs.org/sequelize
npm http 200 https://registry.npmjs.org/sequelize
npm http GET https://registry.npmjs.org/sequelize/-/sequelize-2.0.0-dev11.tgz
npm http 200 https://registry.npmjs.org/sequelize/-/sequelize-2.0.0-dev11.tgz
npm http GET https://registry.npmjs.org/lingo
npm http GET https://registry.npmjs.org/validator
npm http GET https://registry.npmjs.org/moment
npm http GET https://registry.npmjs.org/dottie/0.2.1
npm http GET https://registry.npmjs.org/toposort-class
npm http GET https://registry.npmjs.org/generic-pool/2.0.4
npm http GET https://registry.npmjs.org/commander
npm http GET https://registry.npmjs.org/sql
npm http GET https://registry.npmjs.org/circular-json
npm http GET https://registry.npmjs.org/bluebird
npm http GET https://registry.npmjs.org/lodash
npm http GET https://registry.npmjs.org/underscore.string
npm http GET https://registry.npmjs.org/node-uuid
npm http 200 https://registry.npmjs.org/lingo
npm WARN deprecated lingo@0.0.5: This project is abandoned
npm http GET https://registry.npmjs.org/lingo/-/lingo-0.0.5.tgz
npm http 200 https://registry.npmjs.org/dottie/0.2.1
npm http GET https://registry.npmjs.org/dottie/-/dottie-0.2.1.tgz
npm http 200 https://registry.npmjs.org/toposort-class
npm http GET https://registry.npmjs.org/toposort-class/-/toposort-class-0.3.0.tgz
npm http 200 https://registry.npmjs.org/generic-pool/2.0.4
npm http GET https://registry.npmjs.org/generic-pool/-/generic-pool-2.0.4.tgz
npm http 200 https://registry.npmjs.org/moment
npm http GET https://registry.npmjs.org/moment/-/moment-2.5.1.tgz
npm http 200 https://registry.npmjs.org/circular-json
npm http 200 https://registry.npmjs.org/validator
npm http GET https://registry.npmjs.org/validator/-/validator-3.2.1.tgz
npm http GET https://registry.npmjs.org/circular-json/-/circular-json-0.1.6.tgz
npm http 200 https://registry.npmjs.org/commander
npm http 200 https://registry.npmjs.org/lingo/-/lingo-0.0.5.tgz
npm http GET https://registry.npmjs.org/commander/-/commander-2.1.0.tgz
npm http 200 https://registry.npmjs.org/sql
npm http GET https://registry.npmjs.org/sql/-/sql-0.35.0.tgz
npm http 200 https://registry.npmjs.org/dottie/-/dottie-0.2.1.tgz
npm http 200 https://registry.npmjs.org/toposort-class/-/toposort-class-0.3.0.tgz
npm http 200 https://registry.npmjs.org/moment/-/moment-2.5.1.tgz
npm http 200 https://registry.npmjs.org/underscore.string
npm http 200 https://registry.npmjs.org/commander/-/commander-2.1.0.tgz
npm http 200 https://registry.npmjs.org/node-uuid
npm http 200 https://registry.npmjs.org/circular-json/-/circular-json-0.1.6.tgz
npm http 200 https://registry.npmjs.org/bluebird
npm http 200 https://registry.npmjs.org/sql/-/sql-0.35.0.tgz
npm http GET https://registry.npmjs.org/bluebird/-/bluebird-1.0.8.tgz
npm http 200 https://registry.npmjs.org/validator/-/validator-3.2.1.tgz
npm http 200 https://registry.npmjs.org/generic-pool/-/generic-pool-2.0.4.tgz
npm http 200 https://registry.npmjs.org/lodash
npm http GET https://registry.npmjs.org/lodash/-/lodash-2.4.1.tgz
npm http 200 https://registry.npmjs.org/bluebird/-/bluebird-1.0.8.tgz
npm http 200 https://registry.npmjs.org/lodash/-/lodash-2.4.1.tgz
npm http GET https://registry.npmjs.org/wru
npm http GET https://registry.npmjs.org/sliced
npm http GET https://registry.npmjs.org/lodash/-/lodash-1.3.1.tgz
npm http 200 https://registry.npmjs.org/lodash/-/lodash-1.3.1.tgz
npm http 200 https://registry.npmjs.org/wru
npm http GET https://registry.npmjs.org/wru/-/wru-0.2.7.tgz
npm http 200 https://registry.npmjs.org/sliced
npm http GET https://registry.npmjs.org/sliced/-/sliced-0.0.5.tgz
npm http 200 https://registry.npmjs.org/wru/-/wru-0.2.7.tgz
npm http 200 https://registry.npmjs.org/sliced/-/sliced-0.0.5.tgz
sequelize@2.0.0-dev11 node_modules/sequelize
├── commander@2.1.0
├── dottie@0.2.1
├── toposort-class@0.3.0
├── generic-pool@2.0.4
├── node-uuid@1.4.1
├── validator@3.2.1
├── lingo@0.0.5
├── underscore.string@2.3.3
├── bluebird@1.0.8
├── lodash@2.4.1
├── moment@2.5.1
├── circular-json@0.1.6 (wru@0.2.7)
└── sql@0.35.0 (sliced@0.0.5, lodash@1.3.1)
</code></pre>

<p>We will use sqlite as the database provider:</p>
<ul>
<li><a href="https://github.com/mapbox/node-sqlite3">https://github.com/mapbox/node-sqlite3</a></li>
</ul>
<p>Install using:</p>
<pre><code>npm install sqlite3
</code></pre>

<p>which should respond with:</p>
<pre><code>npm http GET https://registry.npmjs.org/sqlite3
npm http 200 https://registry.npmjs.org/sqlite3
npm http GET https://registry.npmjs.org/sqlite3/-/sqlite3-2.2.3.tgz
npm http 200 https://registry.npmjs.org/sqlite3/-/sqlite3-2.2.3.tgz

&gt; sqlite3@2.2.3 install /Users/edeleastar/repos/modules/active/patterns/prj/pacemaker-node/node_modules/sqlite3
&gt; node-pre-gyp install --fallback-to-build

node-pre-gyp http GET https://node-sqlite3.s3.amazonaws.com/Release/node_sqlite3-v2.2.3-node-v11-darwin-x64.tar.gz
node-pre-gyp http 200 https://node-sqlite3.s3.amazonaws.com/Release/node_sqlite3-v2.2.3-node-v11-darwin-x64.tar.gz
[sqlite3] Success: &quot;/Users/edeleastar/repos/modules/active/patterns/prj/pacemaker-node/node_modules/sqlite3/lib/binding/node-v11-darwin-x64/node_sqlite3.node&quot; is installed
sqlite3@2.2.3 node_modules/sqlite3
</code></pre>
	  </section>
	  <section data-tab="03" class="ui tab stacked moodle-book segment">
	     <h1>Model</h1>
<p>In the pacemaker-node folder, create another folder called 'models', which will contain an analog of the models we created in the play-service application.</p>
<p>Incorporate the following two javascript files:</p>
<h2>users.js</h2>
<pre><code class="javascript">/**
 * Created by tomwalsh on 18/04/2014.
 */
var S = require('sequelize');

var activities = function (){};
var activitiesDAO = {};

var _activitiesDAO = {
  id: {type: S.INTEGER, unique: true, primaryKey: true, autoIncrement: true},
  userId: S.INTEGER,
  kind: S.STRING,
  location: S.STRING,
  distance: S.FLOAT
};


module.exports = function () {
  return new activities ();
};

function _cleanData (data)
{
  if (!data || !data.dataValues)
    return null;

  return data.dataValues;
}

activities.prototype.init = function init (sequelize) {
  activitiesDAO = sequelize.define('activities', _activitiesDAO, {tableName: 'activities', timestamps: false});
};

activities.prototype.readAll = function readAll (usrId, result) {
  activitiesDAO.findAll ({where: {userId: usrId}}).success (function (dataOut) {
    var ret = [];
    for (var i = 0, len = dataOut.length; i &lt; len; i++) {
      ret.push (dataOut[i].dataValues);
    }
    result (ret);
  });
};

activities.prototype.create = function create (usrId, dataIn, result) {
  dataIn.userId = usrId;
  activitiesDAO.build (dataIn).save ().success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};

activities.prototype.read = function read (usrId, activityId, result) {
  activitiesDAO.find ({where: {id: activityId, userId: usrId}}).success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};

activities.prototype.update = function update (usrId, activityId, dataIn, result) {
  activitiesDAO.update (dataIn, {id: activityId, userId: usrId}).success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};

activities.prototype.delete = function del (usrId, activityId, result) {
  activitiesDAO.destroy ({id: activityId, userId: usrId}).success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};
</code></pre>

<h2>activities.js</h2>
<pre><code class="javascript">/**
 * Created by tomwalsh on 18/04/2014.
 */
var S = require('sequelize');

var activities = function (){};
var activitiesDAO = {};

var _activitiesDAO = {
  id: {type: S.INTEGER, unique: true, primaryKey: true, autoIncrement: true},
  userId: S.INTEGER,
  kind: S.STRING,
  location: S.STRING,
  distance: S.FLOAT
};


module.exports = function () {
  return new activities ();
};

function _cleanData (data)
{
  if (!data || !data.dataValues)
    return null;

  return data.dataValues;
}

activities.prototype.init = function init (sequelize) {
  activitiesDAO = sequelize.define('activities', _activitiesDAO, {tableName: 'activities', timestamps: false});
};

activities.prototype.readAll = function readAll (usrId, result) {
  activitiesDAO.findAll ({where: {userId: usrId}}).success (function (dataOut) {
    var ret = [];
    for (var i = 0, len = dataOut.length; i &lt; len; i++) {
      ret.push (dataOut[i].dataValues);
    }
    result (ret);
  });
};

activities.prototype.create = function create (usrId, dataIn, result) {
  dataIn.userId = usrId;
  activitiesDAO.build (dataIn).save ().success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};

activities.prototype.read = function read (usrId, activityId, result) {
  activitiesDAO.find ({where: {id: activityId, userId: usrId}}).success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};

activities.prototype.update = function update (usrId, activityId, dataIn, result) {
  activitiesDAO.update (dataIn, {id: activityId, userId: usrId}).success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};

activities.prototype.delete = function del (usrId, activityId, result) {
  activitiesDAO.destroy ({id: activityId, userId: usrId}).success (function (dataOut) {
    result (_cleanData (dataOut));
  });
};
</code></pre>
	  </section>
	  <section data-tab="04" class="ui tab stacked moodle-book segment">
	     <h1>Controller Infrastructure</h1>
<p>To deliver our application over HTTP, we will equip node with the Express library:</p>
<ul>
<li><a href="http://expressjs.com">http://expressjs.com</a></li>
</ul>
<pre><code>npm install express
</code></pre>

<p>The install should respond by installing its dependencies:</p>
<pre><code>npm http GET https://registry.npmjs.org/express
npm http 200 https://registry.npmjs.org/express
npm http GET https://registry.npmjs.org/express/-/express-4.1.0.tgz
npm http 200 https://registry.npmjs.org/express/-/express-4.1.0.tgz
npm http GET https://registry.npmjs.org/accepts/1.0.1
npm http GET https://registry.npmjs.org/type-is/1.1.0
npm http GET https://registry.npmjs.org/range-parser/1.0.0
npm http GET https://registry.npmjs.org/cookie/0.1.2
npm http GET https://registry.npmjs.org/fresh/0.2.2
npm http GET https://registry.npmjs.org/buffer-crc32/0.2.1
npm http GET https://registry.npmjs.org/methods/0.1.0
npm http GET https://registry.npmjs.org/send/0.3.0
npm http GET https://registry.npmjs.org/cookie-signature/1.0.3
npm http GET https://registry.npmjs.org/merge-descriptors/0.0.2
npm http GET https://registry.npmjs.org/utils-merge/1.0.0
npm http GET https://registry.npmjs.org/escape-html/1.0.1
npm http GET https://registry.npmjs.org/serve-static/1.1.0
npm http GET https://registry.npmjs.org/path-to-regexp/0.1.2
npm http GET https://registry.npmjs.org/qs/0.6.6
npm http GET https://registry.npmjs.org/parseurl/1.0.1
npm http GET https://registry.npmjs.org/debug
npm http 200 https://registry.npmjs.org/accepts/1.0.1
npm http 200 https://registry.npmjs.org/type-is/1.1.0
npm http GET https://registry.npmjs.org/accepts/-/accepts-1.0.1.tgz
npm http GET https://registry.npmjs.org/type-is/-/type-is-1.1.0.tgz
npm http 200 https://registry.npmjs.org/range-parser/1.0.0
npm http GET https://registry.npmjs.org/range-parser/-/range-parser-1.0.0.tgz
npm http 200 https://registry.npmjs.org/fresh/0.2.2
npm http GET https://registry.npmjs.org/fresh/-/fresh-0.2.2.tgz
npm http 200 https://registry.npmjs.org/cookie/0.1.2
npm http GET https://registry.npmjs.org/cookie/-/cookie-0.1.2.tgz
npm http 200 https://registry.npmjs.org/methods/0.1.0
npm http GET https://registry.npmjs.org/methods/-/methods-0.1.0.tgz
npm http 200 https://registry.npmjs.org/cookie-signature/1.0.3
npm http GET https://registry.npmjs.org/cookie-signature/-/cookie-signature-1.0.3.tgz
npm http 200 https://registry.npmjs.org/buffer-crc32/0.2.1
npm http 200 https://registry.npmjs.org/accepts/-/accepts-1.0.1.tgz
npm http GET https://registry.npmjs.org/buffer-crc32/-/buffer-crc32-0.2.1.tgz
npm http 200 https://registry.npmjs.org/send/0.3.0
npm http 200 https://registry.npmjs.org/fresh/-/fresh-0.2.2.tgz
npm http GET https://registry.npmjs.org/send/-/send-0.3.0.tgz
npm http 200 https://registry.npmjs.org/merge-descriptors/0.0.2
npm http GET https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-0.0.2.tgz
npm http 200 https://registry.npmjs.org/cookie-signature/-/cookie-signature-1.0.3.tgz
npm http 200 https://registry.npmjs.org/escape-html/1.0.1
npm http GET https://registry.npmjs.org/escape-html/-/escape-html-1.0.1.tgz
npm http 200 https://registry.npmjs.org/cookie/-/cookie-0.1.2.tgz
npm http 200 https://registry.npmjs.org/buffer-crc32/-/buffer-crc32-0.2.1.tgz
npm http 200 https://registry.npmjs.org/utils-merge/1.0.0
npm http 200 https://registry.npmjs.org/send/-/send-0.3.0.tgz
npm http GET https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.0.tgz
npm http 200 https://registry.npmjs.org/type-is/-/type-is-1.1.0.tgz
npm http 200 https://registry.npmjs.org/path-to-regexp/0.1.2
npm http 200 https://registry.npmjs.org/range-parser/-/range-parser-1.0.0.tgz
npm http 200 https://registry.npmjs.org/qs/0.6.6
npm http 200 https://registry.npmjs.org/merge-descriptors/-/merge-descriptors-0.0.2.tgz
npm http GET https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.2.tgz
npm http GET https://registry.npmjs.org/qs/-/qs-0.6.6.tgz
npm http 200 https://registry.npmjs.org/methods/-/methods-0.1.0.tgz
npm http 200 https://registry.npmjs.org/parseurl/1.0.1
npm http 200 https://registry.npmjs.org/escape-html/-/escape-html-1.0.1.tgz
npm http GET https://registry.npmjs.org/parseurl/-/parseurl-1.0.1.tgz
npm http 200 https://registry.npmjs.org/serve-static/1.1.0
npm http 200 https://registry.npmjs.org/utils-merge/-/utils-merge-1.0.0.tgz
npm http GET https://registry.npmjs.org/serve-static/-/serve-static-1.1.0.tgz
npm http 200 https://registry.npmjs.org/debug
npm http GET https://registry.npmjs.org/debug/-/debug-0.8.0.tgz
npm http 200 https://registry.npmjs.org/qs/-/qs-0.6.6.tgz
npm http 200 https://registry.npmjs.org/parseurl/-/parseurl-1.0.1.tgz
npm http 200 https://registry.npmjs.org/serve-static/-/serve-static-1.1.0.tgz
npm http 200 https://registry.npmjs.org/debug/-/debug-0.8.0.tgz
npm http 200 https://registry.npmjs.org/path-to-regexp/-/path-to-regexp-0.1.2.tgz
npm http GET https://registry.npmjs.org/negotiator
npm http GET https://registry.npmjs.org/mime
npm http GET https://registry.npmjs.org/mime/1.2.11
npm http 200 https://registry.npmjs.org/mime/1.2.11
npm http GET https://registry.npmjs.org/mime/-/mime-1.2.11.tgz
npm http 200 https://registry.npmjs.org/mime
npm http 200 https://registry.npmjs.org/negotiator
npm http GET https://registry.npmjs.org/negotiator/-/negotiator-0.4.3.tgz
npm http 200 https://registry.npmjs.org/mime/-/mime-1.2.11.tgz
npm http 200 https://registry.npmjs.org/negotiator/-/negotiator-0.4.3.tgz
express@4.1.0 ../../../../../../node_modules/express
├── methods@0.1.0
├── parseurl@1.0.1
├── merge-descriptors@0.0.2
├── utils-merge@1.0.0
├── cookie@0.1.2
├── escape-html@1.0.1
├── debug@0.8.0
├── cookie-signature@1.0.3
├── fresh@0.2.2
├── range-parser@1.0.0
├── qs@0.6.6
├── buffer-crc32@0.2.1
├── serve-static@1.1.0
├── path-to-regexp@0.1.2
├── send@0.3.0 (mime@1.2.11)
├── type-is@1.1.0 (mime@1.2.11)
└── accepts@1.0.1 (negotiator@0.4.3, mime@1.2.11)
</code></pre>

<p>We also need a parser for recovering the Json content from the HTTP requests:</p>
<ul>
<li><a href="https://github.com/expressjs/body-parser">https://github.com/expressjs/body-parser</a></li>
</ul>
<pre><code>npm install body-parser
</code></pre>

<pre><code>pm http GET https://registry.npmjs.org/body-parser
npm http 200 https://registry.npmjs.org/body-parser
npm http GET https://registry.npmjs.org/body-parser/-/body-parser-1.0.2.tgz
npm http 200 https://registry.npmjs.org/body-parser/-/body-parser-1.0.2.tgz
npm http GET https://registry.npmjs.org/type-is
npm http GET https://registry.npmjs.org/raw-body
npm http GET https://registry.npmjs.org/qs
npm http 200 https://registry.npmjs.org/raw-body
npm http GET https://registry.npmjs.org/raw-body/-/raw-body-1.1.4.tgz
npm http 200 https://registry.npmjs.org/type-is
npm http 200 https://registry.npmjs.org/qs
npm http 200 https://registry.npmjs.org/raw-body/-/raw-body-1.1.4.tgz
npm http GET https://registry.npmjs.org/bytes
npm http GET https://registry.npmjs.org/mime
npm http 304 https://registry.npmjs.org/mime
npm http 200 https://registry.npmjs.org/bytes
npm http GET https://registry.npmjs.org/bytes/-/bytes-0.3.0.tgz
npm http 200 https://registry.npmjs.org/bytes/-/bytes-0.3.0.tgz
body-parser@1.0.2 node_modules/body-parser
├── qs@0.6.6
├── type-is@1.1.0 (mime@1.2.11)
└── raw-body@1.1.4 (bytes@0.3.0)
</code></pre>

<p>Keep an eye on <code>./pacemaker-node/node_modules</code> folder, it should be populated with the modules we have installed.</p>
	  </section>
	  <section data-tab="05" class="ui tab stacked moodle-book segment">
	     <h1>Controllers</h1>
<p>Create a folder called 'controllers' in pacemaker-node, and incorporate the following two js files:</p>
<h2>users.js</h2>
<pre><code class="javascript">var router = require('express').Router();

/* GET users listing. */
router.get('/', function(req, res) {
  var userDb = req.app.get('userDb');

  userDb.readAll (function (data) {
    res.send(data);
  });
});

router.post('/', function(req, res) {
  var userDb = req.app.get('userDb');

  userDb.create(req.body, function (data) {
    res.send(data);
  });
});

router.get('/:userId', function(req, res) {
  var userDb = req.app.get('userDb');

  userDb.read (req.params.userId, function (user_data) {
    activitiesDb = req.app.get('activitiesDb');

    activitiesDb.readAll (req.params.userId, function (activ_data) {
      user_data.activities = [];
      for (var i=0,  tot=activ_data.length; i &lt; tot; i++) {
        user_data.activities.push(activ_data[i]);
      }

      res.send(user_data);
    });
  });
});

router.put('/:userId', function(req, res) {
  var userDb = req.app.get('userDb');

  userDb.update (req.params.userId, req.body, function (data) {
    res.send(data);
  });
});

router.delete('/:userId', function(req, res) {
  var userDb = req.app.get('userDb');

  userDb.delete (req.params.userId, function (data) {
    res.send(data);
  });
});

module.exports = router;
</code></pre>

<h2>activities.js</h2>
<pre><code class="javascript">/**
 * Created by tomwalsh on 18/04/2014.
 */
var router = require('express').Router();

router.get('/', function(req, res) {
  var activitiesDb = req.app.get('activitiesDb');
  var uId = req.app.get('activityUserId');

  activitiesDb.readAll (uId, function (data) {
    res.send(data);
  });
});

router.post('/', function(req, res) {
  var activitiesDb = req.app.get('activitiesDb');
  var uId = req.app.get('activityUserId');

  activitiesDb.create(uId, req.body, function (data) {
    res.send(data);
  });
});

router.get('/:activityId', function(req, res) {
  var activitiesDb = req.app.get('activitiesDb');
  var uId = req.app.get('activityUserId');

  activitiesDb.read (uId, req.params.activityId, function (data) {
    res.send(data);
  });
});

router.put('/:activityId', function(req, res) {
  var activitiesDb = req.app.get('activitiesDb');
  var uId = req.app.get('activityUserId');

  activitiesDb.update (uId, req.params.activityId, req.body, function (data) {
    res.send(data);
  });
});

router.delete('/:activityId', function(req, res) {
  var activitiesDb = req.app.get('activitiesDb');
  var uId = req.app.get('activityUserId');

  activitiesDb.delete (uId, req.params.activityId, function (data) {
    res.send(data);
  });
});

module.exports = router;
</code></pre>
	  </section>
	  <section data-tab="06" class="ui tab stacked moodle-book segment">
	     <h1>Application</h1>
<p>In the pacemaker-node folder, create the following two files:</p>
<h2>package.json</h2>
<pre><code class="javascript">{
  &quot;name&quot;: &quot;pacemaker-node&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;private&quot;: true,
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;node app&quot;
  },
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;~4.0.0&quot;,
    &quot;sequelize&quot;: &quot;^1.7.2&quot;,
    &quot;body-parser&quot;: &quot;^1.0.2&quot;
  }
}
</code></pre>

<h2>app.js</h2>
<pre><code class="javascript">var express = require('express');
var path = require('path');
var Sequelize = require('sequelize');
var bodyParser = require('body-parser');

var userDb = require('./models/users')();
var activitiesDb = require('./models/activities')();

var sequelize = new Sequelize('pacemaker-node-db', 'root', 'root', {
  dialect: &quot;sqlite&quot;, // or 'sqlite', 'postgres', 'mariadb'
  port:    3306 // or 5432 (for postgres)
});

sequelize.authenticate().complete(function(err) {
  if (!!err) {
    console.log ('Unable to connect to the database:', err);
  } else {
    console.log ('Database has been established successfully.');

    userDb.init (sequelize);
    activitiesDb.init(sequelize);

    sequelize.sync ({ force: false }).complete (function (err) {
      if (!!err) {
        console.log ('An error occurred syncing table:', err);
      } else {
        console.log ('tables synced!');
      }
    });
  }
});

var app = express ();

app.use('/assets', express.static('public'));
//app.use(express.static(path.join(__dirname, 'public')));

app.use(bodyParser());

var users = require('./controllers/users');
var activities = require('./controllers/activities');

// hacky shortcut to get the userid for the activity route
app.use('/api/users/:userId/activities', function (req,res,next) {
  req.app.set('activityUserId', req.params.userId);
  next ();
});
app.use('/api/users/:userId/activities', activities);

app.use('/api/users', users);

app.use('/', function (req, res){
  res.sendfile('./public/pacemaker.html');
});

app.set('userDb', userDb);
app.set('activitiesDb', activitiesDb);

app.listen(8080);
console.log (&quot;masters pacemaker app is listening on port 8080&quot;);
</code></pre>
	  </section>
	  <section data-tab="07" class="ui tab stacked moodle-book segment">
	     <h1>Launch</h1>
<p>To run the application, from the console enter:</p>
<pre><code>node app.js
</code></pre>

<p>which should make the application available on port 8080:</p>
<pre><code>pacemaker-node app is listening on port 8080
Executing (default): SELECT 1+1 AS result
Database has been established successfully.
tables synced!
</code></pre>
	  </section>
	  <section data-tab="Exercises" class="ui tab stacked moodle-book segment">
	     <h1>Exercises</h1>
	  </section>
  <div class="ui fixed bottom borderless menu">'
    <div class="ui small item"> 
    <p id="footertext">
    Prepared by  Eamonn de Leastar (edeleastar@wit.ie). Except where otherwise noted, this content is licensed under a  
     <a  href="http://creativecommons.org/licenses/by-nc/4.0/" title="External link to http://creativecommons.org/licenses/by-nc/4.0/" 
       target="_blank">Creative Commons Attribution-NonCommercial 4.0 License
     </a>
     </p>
    </div>
  </div>   
    
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-49703418-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>  </body>
 </html>